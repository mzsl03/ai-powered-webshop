{% extends 'layout.html' %}

{% load static %}

{% block extra_css %}
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{% static 'css/lists.css' %}">
{% endblock %}


{% block main %}
    <div id="cart-container">
        <table class="cart-list">
            <tr class="cart-header">
                <th>Termékek</th>
                <th>Darabszám</th>
                <th>Szín</th>
                <th>Tárhely</th>
                <th>Státusz</th>
                <th>Rendelés ideje</th>
            </tr>

            {% if orders %}
                {% for order in orders %}
                    <tr class="cart-items">
                        <td>
                            <div class="card">
                                {% with items=order.items.all %}
                                    {% if items %}
                                        <strong>
                                            {{ items.0.product.name }} X {{ items.0.quantity }} DB
                                            {% if items|length > 1 %}
                                                ...
                                            {% endif %}
                                        </strong><br>
                                        <div class="item-list">
                                            {% for item in items %}
                                                <p>{{ item.product.name }} × {{ item.quantity }}</p>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <strong>No items</strong><br>
                                    {% endif %}
                                {% endwith %}
                            </div>
                        </td>
                        <td>
                            {% with total_qty=0 %}
                                {% for item in order.items.all %}
                                    {% widthratio total_qty|add:item.quantity 1 1 as total_qty %}
                                {% endfor %}
                                {{ order.items.all|length }} tétel
                            {% endwith %}
                        </td>
                        <td>
                            {% for item in order.items.all %}
                                {{ item.color }}{% if not forloop.last %}, {% endif %}
                                {% empty %}
                                -
                            {% endfor %}
                        </td>
                        <td>
                            {% for item in order.items.all %}
                                {% if item.storage %}
                                    {% if item.storage > 100 %}
                                        {{ item.storage }} GB{% if not forloop.last %}, {% endif %}
                                    {% else %}
                                        {{ item.storage }} TB{% if not forloop.last %}, {% endif %}
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                                {% empty %}
                                -
                            {% endfor %}
                        </td>
                        <td>
                            <form method="POST" action="{% url 'update_order_status' order.id %}">
                                {% csrf_token %}
                                <select class="selector" name="status" onchange="this.form.submit()">
                                    <option value="feldolgozás_alatt"
                                            {% if order.status == 'feldolgozás_alatt' %}selected{% endif %}>
                                        Feldolgozás alatt
                                    </option>
                                    <option value="kiszállítva"
                                            {% if order.status == 'kiszállítva' %}selected{% endif %}>
                                        Szállítás alatt
                                    </option>
                                    <option value="törölve"
                                            {% if order.status == 'törölve' %}selected{% endif %}>
                                        Kiszállítva
                                    </option>
                                </select>
                            </form>
                        </td>
                        <td>{{ order.order_time|date:"Y-m-d H:i" }}</td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr class="cart-items">
                    <td colspan="6">Nincsenek rendelések</td>
                </tr>
            {% endif %}
        </table>
    </div>
    <script src="{% static 'js/user_order.js' %}"></script>
{% endblock %}