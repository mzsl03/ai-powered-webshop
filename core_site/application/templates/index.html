{% extends 'layout.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    <link rel="stylesheet" href="{% static 'css/filters.css' %}">
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block main %}

    {% if messages %}
        <div id="container-messages">
            {% for message in messages %}
                <span class="success messages">{{ message }}</span>
            {% endfor %}
        </div>
    {% endif %}

    <section class="section hero" id="hero">
        <div class="hero-bg"></div>
        <div class="hero-inner">
            <h1 class="hero-title">AI Powered Webshop</h1>
            <p class="hero-subtitle">
                Minimalista felület. Intelligens ajánlórendszer.
                A jövő vásárlási élménye.
            </p>
            <a href="#products-section" class="btn hero-btn" id="products-btn">Fedezd fel</a>
            <a href="#ai-chat-messages" class="btn hero-btn" id="open-chat">Chatelj az Aszisztensünkkel</a>
        </div>
    </section>

    <section class="section" id="products-section">
        <div class="ind-container" id="products">
            <div class="filters">
                <h3>Szűrők</h3>
                <form method="get" action="#products">
                    <label class="ctrl">
                        <input value="{{ filters.name|default:''}}" name='name' id="q" type="search"
                               placeholder="Keresés (pl. 'fülhallgató')"/>
                    </label>
                    <label class="ctrl">
                        <span class="filter-label">Kategória</span>
                        <select name="category" id="cat">
                            <option value="all">Összes termék</option>
                            {% for category in allCategory %}
                                <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label class="ctrl">
                        <input value="{{ filters.min_price|default:''}}" name="minPrice" type="search"
                               placeholder="Minimum ár"/>
                    </label>
                    <label class="ctrl">
                        <input value="{{ filters.max_price|default:''}}" name="maxPrice" type="search"
                               placeholder="Maximum ár"/>
                    </label>
                    <button class="btn" id="save">Szűrés</button>
                </form>
            </div>
            <div class="product-grid" id="product-grid">
                {% for product in products %}
                    <div class="product-card">
                        <a class="product-link" href="{% url 'product-name' product.name %}">
                            <div class="product-image-container">
                                {% if product.image_path %}
                                    <img data-images="{{ product.image_path|join:", " }}"
                                         src="{% static 'images/' %}{{ product.image_path.0 }}"
                                         alt="{{ product.name }}" class="product-image" id="{{ product.id }}"
                                         width="200">
                                {% else %}
                                    <img src="{% static 'images/no-image.png' %}"
                                         alt="No image available" class="product-image" width="200">
                                {% endif %}
                            </div>
                        </a>
                        <div class="product-info">
                            <a class="product-link" href="{% url 'product-name' product.name %}">
                                <h3 class="product-name">{{ product.name }}</h3>
                                <p class="product-price">{{ product.price }},-Ft</p>
                            </a>
                            <p class="product-colors">
                                {% for color in product.colors %}
                                    <a href="{% url 'product-name' product.name %}"
                                       class="color-circle"
                                       style="background-color: {{ color }}">
                                    </a>
                                {% endfor %}
                            </p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <section class="section" id="ai-chat-messages">
        <div class="chat-div" id="chat-div">
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message-user">Hello!</div>
                    <div class="message-bot">
                        Szia! Miben segíthetek?
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-text" placeholder="Írj az aszisztensnek..."/>
                    <button id="send-btn">Küldés</button>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.getElementById("send-btn").onclick = sendMessage;
        document.getElementById("chat-text").addEventListener("keypress", e => {
            if (e.key === "Enter") sendMessage();
        });

        async function sendMessage() {
            const input = document.getElementById("chat-text");
            const msg = input.value.trim();
            if (!msg) return;

            appendMessage("user", msg);
            input.value = "";

            const res = await fetch("/api/ai-chat/", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({message: msg}),
            });

            const data = await res.json();
            appendMessage("bot", data.reply, data.link);
        }

        function appendMessage(role, text, link = null) {
            const messages = document.getElementById("chat-messages");
            const div = document.createElement("div");
            div.className = `message-${role}`;

            if (link) {
                div.innerHTML = `${text} <a href="${link}" class="chat-link" target="_blank">Megnyitás</a>`;
            } else {
                div.textContent = text;
            }

            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
    </script>

    <script>
        const STATIC_IMAGES_URL = "{% static 'images/' %}";

        document.addEventListener("DOMContentLoaded", () => {
            const sections = [
                document.getElementById("hero"),
                document.getElementById("products-section"),
                document.getElementById("ai-chat-messages")
            ];

            let currentSection = 0;
            let isScrolling = false;
            const scrollDelay = 900;

            function scrollToSection(index) {
                if (index >= 0 && index < sections.length) {
                    currentSection = index;
                    sections[index].scrollIntoView({behavior: "smooth"});
                }
            }

            // Button click handlers
            document.getElementById('open-chat').addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                scrollToSection(2); // Jump to chat section
            });

            document.getElementById('products-btn').addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                scrollToSection(1); // Jump to products section
            });

            // Check if user is scrolling inside a scrollable container
            function isScrollableContainer(target) {
                const chatMessages = document.getElementById("chat-messages");
                const productGrid = document.getElementById("product-grid");
                return chatMessages?.contains(target) || productGrid?.contains(target);
            }

            // Check if scrollable container can scroll in the given direction
            function canScrollInContainer(container, direction) {
                if (direction === "down") {
                    return container.scrollTop < (container.scrollHeight - container.clientHeight - 5);
                } else {
                    return container.scrollTop > 5;
                }
            }

            // Wheel event (desktop) - REMOVED passive: true
            window.addEventListener("wheel", (e) => {
                // Allow normal scrolling inside chat or product grid
                if (isScrollableContainer(e.target)) {
                    const container = e.target.closest("#chat-messages, #product-grid");
                    if (container) {
                        const direction = e.deltaY > 0 ? "down" : "up";
                        if (canScrollInContainer(container, direction)) {
                            return;
                        }
                    }
                }

                if (isScrolling) {
                    e.preventDefault();
                    return;
                }

                e.preventDefault(); // Prevent default scroll
                isScrolling = true;

                if (e.deltaY > 0 && currentSection < sections.length - 1) {
                    currentSection++;
                    scrollToSection(currentSection);
                } else if (e.deltaY < 0 && currentSection > 0) {
                    currentSection--;
                    scrollToSection(currentSection);
                } else {
                    isScrolling = false;
                    return;
                }

                setTimeout(() => (isScrolling = false), scrollDelay);
            });

            // Touch events (mobile)
            let touchStartY = 0;
            let touchEndY = 0;
            let touchStartTarget = null;

            window.addEventListener("touchstart", (e) => {
                touchStartY = e.changedTouches[0].clientY;
                touchStartTarget = e.target;
            });

            window.addEventListener("touchend", (e) => {
                touchEndY = e.changedTouches[0].clientY;

                if (isScrollableContainer(touchStartTarget)) {
                    return;
                }

                handleSwipe();
            });

            function handleSwipe() {
                const swipeDistance = touchStartY - touchEndY;

                if (isScrolling) return;
                isScrolling = true;

                if (swipeDistance > 50 && currentSection < sections.length - 1) {
                    currentSection++;
                } else if (swipeDistance < -50 && currentSection > 0) {
                    currentSection--;
                } else {
                    isScrolling = false;
                    return;
                }

                scrollToSection(currentSection);
                setTimeout(() => (isScrolling = false), scrollDelay);
            }

            // Update current section on scroll
            let scrollTimeout;
            window.addEventListener("scroll", () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const scrollPosition = window.scrollY + window.innerHeight / 2;
                    sections.forEach((section, index) => {
                        const rect = section.getBoundingClientRect();
                        const sectionTop = rect.top + window.scrollY;
                        const sectionBottom = sectionTop + rect.height;

                        if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
                            currentSection = index;
                        }
                    });
                }, 100);
            });

            // Ensure we start at hero on load
            window.scrollTo(0, 0);
        });
    </script>
    <script src="{% static 'js/index.js' %}"></script>
    <script src="{% static 'js/filter.js' %}"></script>
{% endblock %}